<!DOCTYPE html>
<html>
<head>
    <title>Health Scanner Test Battery</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        button { padding: 10px 20px; margin: 5px; }
        img { max-width: 200px; margin: 10px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; font-size: 12px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Health Scanner Test Battery</h1>
    <p>Testing enhanced-health-scanner function with BackendResponse format</p>

    <div class="test-case">
        <h3>Test A: Ping (Transport)</h3>
        <button onclick="runPingTest()">Run Ping Test</button>
        <div id="ping-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test B: Brand + Visible Barcode</h3>
        <img src="test-assets/cereal-barcode.jpg" alt="Cereal with barcode">
        <br>
        <button onclick="runBrandBarcodeTest()">Run Brand+Barcode Test</button>
        <div id="brand-barcode-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test C: Brand Front Only</h3>
        <img src="test-assets/brand-front.jpg" alt="Brand front">
        <br>
        <button onclick="runBrandFrontTest()">Run Brand Front Test</button>
        <div id="brand-front-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test D: Plate (Rice + Beans)</h3>
        <img src="test-assets/rice-beans.jpg" alt="Rice and beans">
        <br>
        <button onclick="runPlateTest()">Run Plate Test</button>
        <div id="plate-result" class="result"></div>
    </div>

    <div class="test-case">
        <h3>Test E: Blurry Photo</h3>
        <img src="test-assets/blurry-food.jpg" alt="Blurry food">
        <br>
        <button onclick="runBlurryTest()">Run Blurry Test</button>
        <div id="blurry-result" class="result"></div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://uzoiiijqtahohfafqirm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV6b2lpaWpxdGFob2hmYWZxaXJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzOTE2MzgsImV4cCI6MjA2Njk2NzYzOH0.Ny_Gxbhus7pNm0OHipRBfaFLNeK_ZSePfbj8no4SVGw';

        async function callHealthScanner(body, testName) {
            const startTime = Date.now();
            const requestId = `test-${testName}-${Date.now()}`;
            
            console.log(`üîç Running ${testName} test...`);
            
            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/enhanced-health-scanner`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ...body, requestId })
                });

                const latencyMs = Date.now() - startTime;
                const data = await response.json();
                
                const logLine = { 
                    reqId: requestId, 
                    status: response.status === 200 ? 'ok' : 'error', 
                    hasBarcode: !!data.barcode, 
                    latencyMs 
                };
                
                console.log(`üìä ${testName} log:`, logLine);
                
                return {
                    success: response.ok,
                    data,
                    requestId,
                    logLine,
                    status: response.status
                };
            } catch (error) {
                const latencyMs = Date.now() - startTime;
                console.error(`‚ùå ${testName} failed:`, error);
                
                return {
                    success: false,
                    error: error.message,
                    requestId,
                    logLine: { reqId: requestId, status: 'error', hasBarcode: false, latencyMs }
                };
            }
        }

        async function runPingTest() {
            const result = await callHealthScanner({ 
                imageBase64: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAABAAEDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAv/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/xAAUEQEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAxEAPwA/wJ8=', 
                mode: 'ping' 
            }, 'ping');
            
            const resultDiv = document.getElementById('ping-result');
            if (result.success) {
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
                    <strong>‚úÖ PASS</strong><br>
                    Request ID: ${result.requestId}<br>
                    Log: ${JSON.stringify(result.logLine)}<br>
                    Response: <pre>${JSON.stringify(result.data, null, 2)}</pre>
                `;
            } else {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
                    <strong>‚ùå FAIL</strong><br>
                    Request ID: ${result.requestId}<br>
                    Error: ${result.error || 'Unknown error'}<br>
                    Log: ${JSON.stringify(result.logLine)}
                `;
            }
        }

        async function imageToBase64(imagePath) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                    resolve(dataURL);
                };
                img.onerror = reject;
                img.src = imagePath;
            });
        }

        async function runBrandBarcodeTest() {
            try {
                const base64 = await imageToBase64('test-assets/cereal-barcode.jpg');
                const result = await callHealthScanner({ imageBase64: base64, mode: 'scan' }, 'brand-barcode');
                
                const resultDiv = document.getElementById('brand-barcode-result');
                const hasBarcode = !!result.data?.barcode;
                const hasRecommendations = result.data?.recommendations?.length >= 2;
                const hasHealthFlags = result.data?.healthFlags?.length > 0;
                
                if (result.success && hasRecommendations) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ PASS</strong><br>
                        Request ID: ${result.requestId}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        Summary: Product "${result.data.productName}", Score: ${result.data.healthScore}, Barcode: ${hasBarcode ? 'Yes' : 'No'}, Flags: ${result.data.healthFlags?.length || 0}<br>
                        <details><summary>Full Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå FAIL</strong><br>
                        Request ID: ${result.requestId}<br>
                        Error: ${result.error || 'Missing required fields'}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        <details><summary>Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                }
            } catch (error) {
                document.getElementById('brand-barcode-result').innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
            }
        }

        async function runBrandFrontTest() {
            try {
                const base64 = await imageToBase64('test-assets/brand-front.jpg');
                const result = await callHealthScanner({ imageBase64: base64, mode: 'scan' }, 'brand-front');
                
                const resultDiv = document.getElementById('brand-front-result');
                const hasRecommendations = result.data?.recommendations?.length >= 2;
                
                if (result.success && hasRecommendations) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ PASS</strong><br>
                        Request ID: ${result.requestId}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        Summary: Product "${result.data.productName}", Score: ${result.data.healthScore}, Recommendations: ${result.data.recommendations?.length || 0}<br>
                        <details><summary>Full Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå FAIL</strong><br>
                        Request ID: ${result.requestId}<br>
                        Error: ${result.error || 'Missing required fields'}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        <details><summary>Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                }
            } catch (error) {
                document.getElementById('brand-front-result').innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
            }
        }

        async function runPlateTest() {
            try {
                const base64 = await imageToBase64('test-assets/rice-beans.jpg');
                const result = await callHealthScanner({ imageBase64: base64, mode: 'scan' }, 'plate');
                
                const resultDiv = document.getElementById('plate-result');
                const hasRecommendations = result.data?.recommendations?.length >= 2;
                const hasFiberProteinTip = result.data?.recommendations?.some(r => 
                    r.toLowerCase().includes('fiber') || r.toLowerCase().includes('protein')
                );
                const hasSodiumTip = result.data?.recommendations?.some(r => 
                    r.toLowerCase().includes('sodium') || r.toLowerCase().includes('rinse')
                );
                
                if (result.success && hasRecommendations) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ PASS</strong><br>
                        Request ID: ${result.requestId}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        Summary: "${result.data.productName}", Score: ${result.data.healthScore}, Fiber/Protein tip: ${hasFiberProteinTip ? 'Yes' : 'No'}, Sodium tip: ${hasSodiumTip ? 'Yes' : 'No'}<br>
                        <details><summary>Full Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå FAIL</strong><br>
                        Request ID: ${result.requestId}<br>
                        Error: ${result.error || 'Missing required fields'}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        <details><summary>Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                }
            } catch (error) {
                document.getElementById('plate-result').innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
            }
        }

        async function runBlurryTest() {
            try {
                const base64 = await imageToBase64('test-assets/blurry-food.jpg');
                const result = await callHealthScanner({ imageBase64: base64, mode: 'scan' }, 'blurry');
                
                const resultDiv = document.getElementById('blurry-result');
                const hasRecommendations = result.data?.recommendations?.length >= 2;
                
                if (result.success && hasRecommendations) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>‚úÖ PASS</strong><br>
                        Request ID: ${result.requestId}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        Summary: Graceful handling - "${result.data.productName}", Score: ${result.data.healthScore}, Recommendations: ${result.data.recommendations?.length || 0}<br>
                        <details><summary>Full Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `
                        <strong>‚ùå FAIL</strong><br>
                        Request ID: ${result.requestId}<br>
                        Error: ${result.error || 'Missing required fields'}<br>
                        Log: ${JSON.stringify(result.logLine)}<br>
                        <details><summary>Response</summary><pre>${JSON.stringify(result.data, null, 2)}</pre></details>
                    `;
                }
            } catch (error) {
                document.getElementById('blurry-result').innerHTML = `<strong>‚ùå ERROR:</strong> ${error.message}`;
            }
        }

        // Auto-run ping test on load
        window.onload = function() {
            console.log('üöÄ Health Scanner Test Battery loaded');
        };
    </script>
</body>
</html>